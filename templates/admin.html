<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kiosk Admin</title>
<style>
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, #a7ffeb 0%, #64b5f6 60%, #1de9b6 100%);
  font-family: 'Inter', system-ui, sans-serif;
  color: #222;
}
.wrap {
  max-width: 500px;
  margin: 0 auto;
  padding: 44px 0 0 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.card {
  background: rgba(255,255,255,0.22);
  box-shadow: 0 8px 32px #0002;
  border-radius: 22px;
  padding: 32px 28px 28px 28px;
  width: 100%;
  max-width: 420px;
  margin-bottom: 32px;
  backdrop-filter: blur(14px) saturate(120%);
  border: 1.5px solid rgba(0,0,0,0.08);
}
h1 {
  font-size: 2em;
  font-weight: 700;
  margin: 0 0 18px 0;
  text-align: center;
  color: #00897b;
  letter-spacing: 1px;
}
.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  justify-content: center;
}
.btn {
  padding: 12px 18px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(90deg,#1de9b6 0%,#64b5f6 100%);
  color: #00695c;
  font-weight: 700;
  font-size: 1.1em;
  cursor: pointer;
  margin-bottom: 6px;
  box-shadow: 0 2px 8px #0001;
  transition: filter .2s;
}
.btn:hover { filter: brightness(1.08); }
.input {
  padding: 13px;
  border-radius: 12px;
  border: 1.5px solid #b2dfdb;
  background: rgba(255,255,255,0.18);
  color: #111;
  font-size: 1.1em;
  width: 100%;
  margin-bottom: 10px;
  outline: none; transition: border .2s;
}
.input:focus { border: 1.5px solid #1de9b6; }
.status-card {
  background: rgba(255,255,255,0.13);
  border-radius: 18px;
  padding: 18px 16px;
  margin-top: 18px;
  text-align: center;
  box-shadow: 0 2px 12px #0002;
}
.status-title { font-size: 1.2em; font-weight: 700; margin-bottom: 8px; color: #00897b;}
.status-main { font-size: 1.3em; font-weight: 800; margin-bottom: 4px; }
.status-meta { color: #039be5; font-size: 1em; }
.urgent-inbox {
  background: rgba(255,255,255,0.18);
  border-radius: 18px;
  padding: 18px 16px;
  margin-top: 18px;
  box-shadow: 0 2px 12px #0001;
}
.urgent-inbox h2 {
  font-size: 1.1em;
  color: #009688;
  margin: 0 0 10px 0;
  font-weight: 700;
}
.urgent-msg {
  background: rgba(255,255,255,0.13);
  border-radius: 12px;
  padding: 10px 12px;
  margin-bottom: 10px;
  color: #222;
  font-size: 1em;
  box-shadow: 0 1px 4px #0001;
}
.urgent-msg .meta {
  color: #039be5;
  font-size: 0.95em;
  float: right;
}
.urgent-msg .reason {
  color: #009688;
  font-weight: 700;
  margin-right: 8px;
}
.urgent-msg .name, .urgent-msg .designation {
  color: #111;
  font-size: 0.98em;
  margin-top: 2px;
  font-weight: 500;
  display: inline-block;
}
.replybox { margin-top: 10px; }
.replyrow { display: flex; gap: 8px; margin-top: 8px; }
.replyrow .input { margin-bottom: 0; }
.reply-thread {
  margin-top: 8px;
  font-size: 0.98em;
  color: #00695c;
  background: rgba(255,255,255,0.13);
  border-radius: 8px;
  padding: 7px 10px;
}
.reply-thread .meta { color: #039be5; font-size: 0.95em; float: right;}
@media (max-width: 600px) {
  .wrap, .card, .urgent-inbox { max-width: 98vw; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Principal Kiosk — Admin</h1>
    <div class="row">
      <button class="btn" onclick="setCustom('Principal Room')">Principal Room</button>
      <button class="btn" onclick="setCustom('Office')">Office</button>
      <button class="btn" onclick="setCustom('Documentation Room')">Documentation Room</button>
      <button class="btn" onclick="setCustom('OTS')">OTS</button>
      <button class="btn" onclick="setCustom('Primary Block OTS')">Primary Block OTS</button>
      <button class="btn" onclick="setCustom('Library')">Library</button>
      <button class="btn" onclick="setCustom('Physics Lab')">Physics Lab</button>
      <button class="btn" onclick="setCustom('Chemistry Lab')">Chemistry Lab</button>
      <button class="btn" onclick="setCustom('CS Lab')">CS Lab</button>
      <button class="btn" onclick="setCustom('ATL Lab')">ATL Lab</button>
      <button class="btn" onclick="setCustom('Reception')">Reception</button>
      <button class="btn" onclick="setStatus('Absent Today')">Absent Today</button>
      <button class="btn" onclick="setStatus('In Meeting')">In Meeting</button>
      <button class="btn" onclick="setStatus('Out of School')">Out of School</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input class="input" id="customLoc" placeholder="Type any location (e.g., Class 7A)">
      <button class="btn" type="button" onclick="setCustomField()">Set Custom Location</button>
    </div>
  </div>
  <div class="status-card">
    <div class="status-title">Current Status</div>
    <div class="status-main" id="status">Loading…</div>
    <div class="status-meta" id="meta"></div>
  </div>
  <div class="urgent-inbox">
    <h2>Urgent Messages</h2>
    <div id="urgentList"></div>
  </div>
</div>
<script>
async function setCustom(location){
  let status = (
    location.toLowerCase().includes("lab") ||
    location.toLowerCase().includes("class")
  ) ? "Visiting" : "In";
  await fetch('/api/set',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({status, location})
  });
  alert('Updated: ' + status + (location? (' — ' + location): ''));
  refresh();
}
async function setStatus(status){
  await fetch('/api/set',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({status, location:""})
  });
  alert('Updated: ' + status);
  refresh();
}
async function setCustomField(){
  const location = (document.getElementById('customLoc').value||'').trim();
  if(!location){ alert('Enter a location'); return; }
  let status = (
    location.toLowerCase().includes("lab") ||
    location.toLowerCase().includes("class")
  ) ? "Visiting" : "In";
  await fetch('/api/set',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({status, location})
  });
  alert('Updated: ' + status + (location? (' — ' + location): ''));
  document.getElementById('customLoc').value = '';
  refresh();
}
async function refresh(){
  try{
    const r = await fetch('/status',{cache:'no-store'}); const s = await r.json();
    let status = s.status || "";
    let location = s.location || "";
    if (status.toLowerCase().includes("absent")) {
      document.getElementById('status').textContent = "Principal is absent today";
      document.getElementById('meta').textContent = "";
    } else if (status.toLowerCase().includes("meeting")) {
      document.getElementById('status').textContent = "Principal is in meeting";
      document.getElementById('meta').textContent = "";
    } else if (status.toLowerCase().includes("out")) {
      document.getElementById('status').textContent = "Principal is out of school";
      document.getElementById('meta').textContent = "";
    } else if (
      status.toLowerCase().includes("visiting") ||
      (location && (
        location.toLowerCase().includes("lab") ||
        location.toLowerCase().includes("class")
      ))
    ) {
      document.getElementById('status').textContent = "Principal is visiting — " + location;
      document.getElementById('meta').textContent = "Updated " + new Date(s.since*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    } else if (
      location &&
      (
        location.toLowerCase().includes("ots") ||
        location.toLowerCase().includes("office") ||
        location.toLowerCase().includes("room") ||
        location.toLowerCase().includes("reception") ||
        location.toLowerCase().includes("library")
      )
    ) {
      document.getElementById('status').textContent = "Principal is in — " + location;
      document.getElementById('meta').textContent = "Updated " + new Date(s.since*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    } else {
      document.getElementById('status').textContent = "Principal is in — " + location;
      document.getElementById('meta').textContent = "Updated " + new Date(s.since*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }
  }catch(e){}
}
setInterval(refresh, 2000); refresh();

async function loadUrgent(){
  const box = document.getElementById('urgentList');
  try{
    const r = await fetch('/urgent'); const j = await r.json();
    const urgent = j.urgent;
    if (!urgent.length) {
      box.innerHTML = '<div style="color:#888;">No urgent messages</div>';
      return;
    }
    box.innerHTML = urgent.map(m => `
      <div class="urgent-msg" id="msg-${m.id}">
        <span class="reason">${m.reason}:</span>
        <span class="text">${m.text}</span>
        ${m.name || m.designation ? `<div class="name">${m.name ? m.name : ""}${m.name && m.designation ? ", " : ""}</div><div class="designation">${m.designation ? m.designation : ""}</div>` : ""}
        <span class="meta">${new Date(m.time*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
        <div class="replybox">
          <div class="reply-thread" id="reply-thread-${m.id}">
            ${m.reply ? `<span>Principal: ${m.reply.text}</span> <span class="meta">${new Date(m.reply.time*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>` : '<span style="color:#888;">No reply yet</span>'}
          </div>
          <div class="replyrow">
            <button class="btn" onclick="quickReply(${m.id},'I am on my way')">I am on my way</button>
            <button class="btn" onclick="quickReply(${m.id},'Please wait in my office')">Please wait in my office</button>
            <button class="btn" onclick="quickReply(${m.id},'I will call you')">I will call you</button>
          </div>
          <div class="replyrow">
            <input class="input" id="reply-${m.id}" autocomplete="off" placeholder="Custom reply…">
            <button class="btn" onclick="sendTextReply(${m.id})">Send</button>
          </div>
        </div>
      </div>
    `).join('');
  }catch(e){ box.innerHTML = '<div style="color:#888;">Error loading urgent messages</div>'; }
}
function quickReply(id, text){
  fetch('/reply', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id, text})
  }).then(loadUrgent);
}
function sendTextReply(id){
  const input = document.getElementById('reply-'+id);
  const text = (input.value||'').trim();
  if (!text) { alert('Type a reply'); return; }
  fetch('/reply', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id, text})
  }).then(()=>{ input.value=''; loadUrgent(); });
}
setInterval(loadUrgent, 2000); loadUrgent();
</script>
</body>
</html>
