<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=800, initial-scale=1">
<title>Kiosk ‚Äî Principal Status</title>
<style>
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, #a7ffeb 0%, #64b5f6 60%, #1de9b6 100%);
  font-family: 'Inter', system-ui, sans-serif;
  color: #222;
  font-size: 1.25em;
}
.topbar {
  width: 100vw;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0; left: 0; right: 0;
  padding: 8px 18px 0 18px;
  z-index: 2;
  pointer-events: none;
}
.topbar .date, .topbar .time {
  font-size: 1.1em;
  font-weight: 600;
  color: #00897b;
  background: rgba(255,255,255,0.18);
  border-radius: 12px;
  padding: 7px 16px;
  box-shadow: 0 2px 8px #0001;
  pointer-events: auto;
}
.hotzone {
  position: fixed; top: 0; left: 0; width: 60px; height: 60px; z-index: 20;
  background: transparent;
}
.wrap {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.card {
  background: rgba(255,255,255,0.22);
  box-shadow: 0 8px 32px #0002;
  border-radius: 22px;
  padding: 18px 2vw 18px 2vw;
  width: 98vw;
  min-width: 0;
  max-width: none;
  backdrop-filter: blur(14px) saturate(120%);
  border: 1.5px solid rgba(0,0,0,0.08);
  margin-bottom: 18px;
  text-align: center;
  margin-top: 60px;
}
.position-box {
  background: rgba(255,255,255,0.30);
  border-radius: 16px;
  box-shadow: 0 2px 8px #0001;
  padding: 18px 10px 14px 10px;
  margin: 0 auto 22px auto;
  width: 90vw;
  font-size: 1.3em;
  font-weight: 700;
  color: #00695c;
  letter-spacing: 0.5px;
  border: 1.5px solid #b2dfdb;
}
.line1 { font-size: 2.1em; font-weight: 800; margin-bottom: 0.3em; color: #00695c;}
.line3 { font-size: 1.1em; color: #039be5; margin-bottom: 1.2em; }
.row { display: flex; gap: 18px; justify-content: center; margin-bottom: 18px; }
.btn {
  padding: 18px 0;
  border-radius: 12px;
  border: none;
  background: linear-gradient(90deg,#1de9b6 0%,#64b5f6 100%);
  color: #00695c;
  font-weight: 700;
  font-size: 1.3em;
  cursor: pointer;
  min-width: 160px;
  min-height: 60px;
  box-shadow: 0 2px 8px #0001;
  transition: filter .2s;
}
.btn:active { filter: brightness(0.95);}
.btn-urgent { background: linear-gradient(90deg,#009688 0%,#64b5f6 100%); color: #fff; }
.btn-request { background: linear-gradient(90deg,#b2ff59 0%,#1de9b6 100%); color: #00695c; }
.btn-request.stale-strong { background: linear-gradient(90deg,#26c6da 0%,#1de9b6 100%); color: #222; }
.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,.45);
  display: none; align-items: center; justify-content: center; z-index: 10;
}
.modal .card {
  width: 96vw; max-width: 96vw; min-width: 0;
  padding: 18px 2vw 18px 2vw;
}
.tiles {
  display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; margin: 10px 0 14px 0;
}
.tile {
  padding: 18px 0; border-radius: 12px; text-align: center; font-weight: 700;
  border: 1.5px solid #b2dfdb; background: rgba(255,255,255,0.13);
  cursor: pointer; user-select: none; font-size: 1.2em; color: #00695c;
  transition: background .2s, color .2s;
}
.tile.active {
  background: linear-gradient(90deg,#1de9b6 0%,#64b5f6 100%);
  color: #fff;
  border: 1.5px solid #1de9b6;
}
.field { margin-top: 12px; display: flex; gap: 12px; }
.input {
  width: 100%; padding: 16px; border-radius: 12px; border: 1.5px solid #b2dfdb;
  background: rgba(255,255,255,0.18); color: #111; font-size: 1.2em; margin-bottom: 10px;
  outline: none; transition: border .2s;
}
.input:focus { border: 1.5px solid #1de9b6; }
textarea.msg {
  width: 100%; height: 80px; padding: 14px; border-radius: 12px;
  border: 1.5px solid #b2dfdb; background: rgba(255,255,255,0.18);
  color: #111; font-size: 1.2em; resize: none; margin-bottom: 8px;
  box-sizing: border-box;
  outline: none;
  transition: border .2s;
  display: block;
}
textarea.msg:focus { border: 1.5px solid #1de9b6; }
.count { font-size: 14px; opacity: .75; margin-top: 2px; text-align: right; }
.actions { display: flex; gap: 14px; margin-top: 14px; justify-content: center; }
.btn-secondary {
  background: linear-gradient(90deg,#b2dfdb 0%,#64b5f6 100%);
  color: #00695c;
}
.toast {
  position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
  background: rgba(0,0,0,.6); border: 1px solid rgba(255,255,255,.12);
  padding: 12px 18px; border-radius: 10px; opacity: 0; pointer-events: none; color: #fff; z-index: 20;
  transition: opacity .25s ease, transform .25s ease;
  font-size: 1.2em;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px);}
.urgent-msg-box, .urgent-reply-box {
  background: rgba(255,255,255,0.18);
  border-radius: 16px;
  margin: 18px 0 0 0;
  padding: 16px 14px 14px 14px;
  box-shadow: 0 2px 8px #0001;
  text-align: left;
  font-size: 1.18em;
  min-height: 40px;
  width: 90vw;
  max-width: 90vw;
  margin-left: auto;
  margin-right: auto;
}
.urgent-msg-box .label {
  color: #009688; font-weight: 700; margin-right: 8px;
}
.urgent-msg-box .msg {
  color: #111; font-weight: 500;
}
.urgent-msg-box .meta {
  color: #039be5; font-size: 0.95em; float: right;
}
.urgent-reply-box {
  margin-top: 12px;
  background: rgba(255,255,255,0.28);
  border: 1.5px solid #b2dfdb;
}
.urgent-reply-box .reply-label {
  color: #039be5; font-weight: 700; margin-right: 8px; display: block; margin-bottom: 6px;
}
.urgent-reply-box .reply {
  color: #111; font-weight: 600;
}
.urgent-reply-box .meta {
  color: #039be5; font-size: 0.95em; float: right;
}
#osk .osk-row {
  display: flex;
  justify-content: center;
  margin-bottom: 4px;
}
#osk .osk-key {
  flex: 1 1 0;
  min-width: 44px;
  max-width: 60px;
  margin: 2px;
  padding: 18px 0;
  border-radius: 8px;
  border: 1px solid #b2dfdb;
  background: #e0f7fa;
  font-weight: 700;
  font-size: 1.3em;
  color: #111;
  text-align: center;
  cursor: pointer;
  user-select: none;
  transition: background .2s;
}
#osk .osk-key.space { min-width: 120px; max-width: 180px; flex: 2 1 0; }
#osk .osk-key.backspace { min-width: 80px; max-width: 120px; }
#osk .osk-key:active { background: #b2ebf2; }
@media (max-width: 600px) {
  .wrap, .card, .urgent-msg-box, .urgent-reply-box { max-width: 98vw; }
  .topbar { padding: 10px 6vw 0 6vw; }
  .field { flex-direction: column; gap: 0; }
}
</style>
</head>
<body>
<div class="topbar">
  <div class="date" id="date"></div>
  <div class="time" id="time"></div>
</div>
<div class="hotzone" id="hotzone" title="Triple-tap for admin"></div>
<div class="wrap">
  <div class="card">
    <div class="line1" id="line1"></div>
    <div class="position-box" id="positionBox"></div>
    <div class="line3" id="line3"></div>
    <div class="row">
      <button class="btn btn-urgent" id="urgentBtn">üö® Urgent message</button>
      <button class="btn btn-request" id="requestBtn" style="display:none;">üîî Request position</button>
    </div>
    <div class="urgent-msg-box" id="urgentMsgBox" style="display:none;">
      <span class="label">Your urgent message:</span>
      <span class="msg" id="urgentMsgText"></span>
      <span class="meta" id="urgentMsgTime"></span>
    </div>
    <div class="urgent-reply-box" id="urgentReplyBox" style="display:none;">
      <span class="reply-label">Reply from Principal:</span>
      <span class="reply" id="urgentReplyText"></span>
      <span class="meta" id="urgentReplyTime"></span>
    </div>
  </div>
</div>

<!-- Urgent modal -->
<div class="modal" id="urgentModal" aria-hidden="true">
  <div class="card">
    <h3 style="margin-top:0;">Send urgent message</h3>
    <div class="tiles" id="reasonTiles">
      <div class="tile active" data-reason="Student emergency">üöë<br>Student</div>
      <div class="tile" data-reason="Parent waiting">üë™<br>Parent</div>
      <div class="tile" data-reason="Staff help">üßë‚Äçüè´<br>Staff</div>
      <div class="tile" data-reason="Document/signature">üìù<br>Document</div>
      <div class="tile" data-reason="Other">üîñ<br>Other</div>
    </div>
    <div class="field">
      <input id="urgentName" class="input" autocomplete="off" placeholder="Your name (optional)">
      <input id="urgentDesig" class="input" autocomplete="off" placeholder="Your designation (optional)">
    </div>
    <div class="field">
      <textarea id="urgentMsg" class="msg" rows="3" autocomplete="off" placeholder="Type your message (max 200 chars)" maxlength="200"></textarea>
      <div class="count" id="msgCount">0 / 200</div>
    </div>
    <div id="osk" style="margin-top:10px;"></div>
    <div class="actions">
      <button class="btn btn-secondary" id="cancelUrgent">Cancel</button>
      <button class="btn btn-urgent" id="sendUrgent">Send</button>
    </div>
  </div>
</div>
<div class="toast" id="toast">Sent</div>

<script>
let statusText = 'In Office', locationText = "Principal's Office", lastUpdated = Date.now() - 10000;
let lastUrgent = null;

const line1 = document.getElementById('line1');
const positionBox = document.getElementById('positionBox');
const line3 = document.getElementById('line3');
const requestBtn = document.getElementById('requestBtn');
const urgentBtn = document.getElementById('urgentBtn');
const urgentModal = document.getElementById('urgentModal');
const cancelUrgent = document.getElementById('cancelUrgent');
const sendUrgent = document.getElementById('sendUrgent');
const msgEl = document.getElementById('urgentMsg');
const countEl = document.getElementById('msgCount');
const tiles = Array.from(document.querySelectorAll('.tile'));
const urgentMsgBox = document.getElementById('urgentMsgBox');
const urgentMsgText = document.getElementById('urgentMsgText');
const urgentMsgTime = document.getElementById('urgentMsgTime');
const urgentReplyBox = document.getElementById('urgentReplyBox');
const urgentReplyText = document.getElementById('urgentReplyText');
const urgentReplyTime = document.getElementById('urgentReplyTime');
const dateEl = document.getElementById('date');
const timeEl = document.getElementById('time');
const urgentName = document.getElementById('urgentName');
const urgentDesig = document.getElementById('urgentDesig');

function fmtTime(ts){ return new Date(ts*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function fmtDate(ts){ return new Date(ts*1000).toLocaleDateString([], {weekday:'short', year:'numeric', month:'short', day:'numeric'}); }
function updateKioskDisplay(s) {
  let status = s.status || "";
  let location = s.location || "";
  if (status.toLowerCase().includes("absent")) {
    line1.textContent = "Principal is absent today";
    positionBox.textContent = "";
  } else if (status.toLowerCase().includes("meeting")) {
    line1.textContent = "Principal is in meeting";
    positionBox.textContent = "";
  } else if (status.toLowerCase().includes("out")) {
    line1.textContent = "Principal is out of school";
    positionBox.textContent = "";
  } else if (
    status.toLowerCase().includes("visiting") ||
    (location && (
      location.toLowerCase().includes("lab") ||
      location.toLowerCase().includes("class")
    ))
  ) {
    line1.textContent = "Principal is visiting";
    positionBox.textContent = location;
  } else if (
    location &&
    (
      location.toLowerCase().includes("ots") ||
      location.toLowerCase().includes("office") ||
      location.toLowerCase().includes("room") ||
      location.toLowerCase().includes("reception") ||
      location.toLowerCase().includes("library")
    )
  ) {
    line1.textContent = "Principal is in";
    positionBox.textContent = location;
  } else {
    line1.textContent = "Principal is in";
    positionBox.textContent = location;
  }
  line3.textContent = "Updated " + fmtTime(s.since);
}

async function refreshUI(){
  try {
    const r = await fetch('/status',{cache:'no-store'}); const s = await r.json();
    updateKioskDisplay(s);
    const ageSec = Math.floor((s.server_time - s.since));
    if (ageSec >= 60*20){
      requestBtn.style.display = 'inline-block';
      if (ageSec >= 60*40) requestBtn.classList.add('stale-strong');
      else requestBtn.classList.remove('stale-strong');
    } else {
      requestBtn.style.display = 'none';
      requestBtn.classList.remove('stale-strong');
    }
    // Show urgent message and reply
    lastUrgent = s.urgent;
    if (lastUrgent) {
      urgentMsgBox.style.display = '';
      let nameDesig = (lastUrgent.name || "") + (lastUrgent.name && lastUrgent.designation ? ", " : "") + (lastUrgent.designation || "");
      urgentMsgText.textContent = lastUrgent.reason + ': ' + lastUrgent.text + (nameDesig ? " (" + nameDesig + ")" : "");
      urgentMsgTime.textContent = fmtTime(lastUrgent.time);
      if (lastUrgent.reply) {
        urgentReplyBox.style.display = '';
        urgentReplyText.textContent = lastUrgent.reply.text;
        urgentReplyTime.textContent = fmtTime(lastUrgent.reply.time);
      } else {
        urgentReplyBox.style.display = 'none';
      }
    } else {
      urgentMsgBox.style.display = 'none';
      urgentReplyBox.style.display = 'none';
    }
    // Date/time
    const nowd = new Date();
    dateEl.textContent = nowd.toLocaleDateString([], {weekday:'short', year:'numeric', month:'short', day:'numeric'});
    timeEl.textContent = nowd.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  } catch(e){}
}
setInterval(refreshUI, 2000); refreshUI();

function toast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }

urgentBtn.onclick = ()=>{ urgentModal.style.display='flex'; urgentModal.setAttribute('aria-hidden','false'); renderOSK(msgEl); setTimeout(()=>msgEl.focus(),50); };
cancelUrgent.onclick = ()=>{ urgentModal.style.display='none'; urgentModal.setAttribute('aria-hidden','true'); osk.innerHTML = ''; };
tiles.forEach(t=> t.addEventListener('click', ()=>{ tiles.forEach(x=>x.classList.remove('active')); t.classList.add('active'); }));
msgEl.addEventListener('input', ()=> countEl.textContent = `${msgEl.value.length} / 200`);
sendUrgent.onclick = async ()=>{
  const text = msgEl.value.trim();
  const name = urgentName.value.trim();
  const desig = urgentDesig.value.trim();
  if(!text){ toast('Please enter a message'); return; }
  urgentModal.style.display='none'; urgentModal.setAttribute('aria-hidden','true'); osk.innerHTML = '';
  const reason = tiles.find(x=>x.classList.contains('active')).getAttribute('data-reason');
  const fd = new FormData();
  fd.append('reason', reason);
  fd.append('message', text);
  fd.append('name', name);
  fd.append('designation', desig);
  await fetch('/urgent', {method:'POST', body:fd});
  toast('Sent: ' + reason + ': ' + text);
  msgEl.value=''; countEl.textContent='0 / 200';
  urgentName.value = '';
  urgentDesig.value = '';
  setTimeout(refreshUI, 1000);
};
requestBtn.onclick = ()=>{ toast('Request sent (demo)'); };

// Triple-tap top-left corner to open /admin
const hotzone = document.getElementById('hotzone');
let taps = 0, tmr = null;
hotzone.addEventListener('click', ()=>{
  taps++; clearTimeout(tmr); tmr = setTimeout(()=>taps=0, 900);
  if (taps >= 3) { window.location.href = '/admin'; taps = 0; }
});

// On-screen keyboard for urgent modal
const osk = document.getElementById('osk');
let oskTarget = null;
const oskLayout = [
  ['q','w','e','r','t','y','u','i','o','p'],
  ['a','s','d','f','g','h','j','k','l'],
  ['z','x','c','v','b','n','m','.','?','!'],
  ['1','2','3','4','5','6','7','8','9','0'],
  ['@','_','-','/','(',')',',','\'','"'],
  ['Space','Backspace']
];
function renderOSK(target) {
  osk.innerHTML = '';
  oskTarget = target;
  oskLayout.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'osk-row';
    row.forEach(key => {
      const btn = document.createElement('button');
      btn.className = 'osk-key' + (key === 'Space' ? ' space' : '') + (key === 'Backspace' ? ' backspace' : '');
      btn.textContent = key === 'Space' ? '‚ê£' : (key === 'Backspace' ? '‚å´' : key);
      btn.onclick = () => {
        if (!oskTarget) return;
        if (key === 'Space') insertAtCursor(oskTarget, ' ');
        else if (key === 'Backspace') backspaceAtCursor(oskTarget);
        else insertAtCursor(oskTarget, key);
        oskTarget.focus();
        if (oskTarget.id === 'urgentMsg') oskTarget.dispatchEvent(new Event('input'));
      };
      rowDiv.appendChild(btn);
    });
    osk.appendChild(rowDiv);
  });
}
function insertAtCursor(input, text) {
  if (document.activeElement !== input) input.focus();
  if (input.setRangeText) {
    const start = input.selectionStart, end = input.selectionEnd;
    input.setRangeText(text, start, end, 'end');
  } else {
    input.value += text;
  }
}
function backspaceAtCursor(input) {
  if (document.activeElement !== input) input.focus();
  const start = input.selectionStart, end = input.selectionEnd;
  if (start > 0) {
    input.value = input.value.slice(0, start-1) + input.value.slice(end);
    input.setSelectionRange(start-1, start-1);
  }
}
['urgentName','urgentDesig','urgentMsg'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('focus', ()=>renderOSK(el));
});
urgentModal.addEventListener('click', e => {
  if (![...['urgentName','urgentDesig','urgentMsg']].includes(e.target.id)) osk.innerHTML = '';
});
</script>
</body>
</html>
